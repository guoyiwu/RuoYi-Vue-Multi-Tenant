package com.ruoyi.sast.coderabbit2;

import java.io.IOException;
import java.io.StringReader;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.parsers.SAXParser;
import javax.xml.parsers.SAXParserFactory;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.stream.StreamSource;
import org.w3c.dom.Document;
import org.xml.sax.InputSource;
import org.xml.sax.SAXException;

/**
 * ã€è§„åˆ™9ã€‘æ¼æ´ - é˜»æ–­
 * XML parsers should not be vulnerable to XXE attacks
 * XMLè§£æå™¨ä¸åº”è¯¥å®¹æ˜“å—åˆ°XXEæ”»å‡»
 *
 * é—®é¢˜ï¼šä¸å®‰å…¨çš„XMLè§£æé…ç½®å¯èƒ½å¯¼è‡´ï¼š
 *       - è¯»å–æœåŠ¡å™¨æ•æ„Ÿæ–‡ä»¶ï¼ˆå¦‚/etc/passwdï¼‰
 *       - æœåŠ¡ç«¯è¯·æ±‚ä¼ªé€ ï¼ˆSSRFï¼‰
 *       - æ‹’ç»æœåŠ¡æ”»å‡»ï¼ˆBillion Laughsï¼‰
 */
public class XxeVulnerability {

    // ğŸš¨ è¿è§„ï¼šä½¿ç”¨é»˜è®¤é…ç½®çš„DocumentBuilderï¼ˆæ˜“å—XXEæ”»å‡»ï¼‰
    public Document parseXmlUnsafe(String xmlContent) 
            throws ParserConfigurationException, SAXException, IOException {
        
        // ğŸš¨ è¿è§„ï¼šé»˜è®¤é…ç½®å…è®¸å¤–éƒ¨å®ä½“è§£æ
        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
        DocumentBuilder builder = factory.newDocumentBuilder();
        
        // æ¶æ„XMLç¤ºä¾‹å¯èƒ½è¯»å–/etc/passwd:
        // <!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///etc/passwd">]>
        // <foo>&xxe;</foo>
        return builder.parse(new InputSource(new StringReader(xmlContent)));
    }

    // ğŸš¨ è¿è§„ï¼šSAXParseré»˜è®¤é…ç½®ä¸å®‰å…¨
    public void parseSaxUnsafe(String xmlContent) throws Exception {
        // ğŸš¨ è¿è§„ï¼šæ²¡æœ‰ç¦ç”¨å¤–éƒ¨å®ä½“
        SAXParserFactory factory = SAXParserFactory.newInstance();
        SAXParser parser = factory.newSAXParser();
        
        parser.parse(new InputSource(new StringReader(xmlContent)), 
                     new org.xml.sax.helpers.DefaultHandler());
    }

    // ğŸš¨ è¿è§„ï¼šTransformerFactoryé»˜è®¤é…ç½®ä¸å®‰å…¨
    public void transformUnsafe(String xsltContent) throws Exception {
        // ğŸš¨ è¿è§„ï¼šæ²¡æœ‰ç¦ç”¨å¤–éƒ¨å®ä½“å¤„ç†
        TransformerFactory factory = TransformerFactory.newInstance();
        
        factory.newTransformer(new StreamSource(new StringReader(xsltContent)));
    }

    // ğŸš¨ è¿è§„ï¼šä»…ç¦ç”¨éƒ¨åˆ†ç‰¹æ€§ï¼Œä»ç„¶ä¸å®‰å…¨
    public Document parsePartiallySecure(String xmlContent) throws Exception {
        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
        
        // ğŸš¨ è¿è§„ï¼šåªç¦ç”¨äº†DTDï¼Œä½†æ²¡æœ‰ç¦ç”¨å¤–éƒ¨å®ä½“
        factory.setFeature("http://apache.org/xml/features/disallow-doctype-decl", false);
        // ç¼ºå°‘å…¶ä»–å¿…è¦çš„å®‰å…¨é…ç½®
        
        DocumentBuilder builder = factory.newDocumentBuilder();
        return builder.parse(new InputSource(new StringReader(xmlContent)));
    }
}
